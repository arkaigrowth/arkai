# Ticket: Gmail Core Pipeline (Layers A-G)
# Worker: triage-sidecar
# Priority: HIGH - Core functionality

id: GMAIL_CORE_PIPELINE
worker: triage-sidecar
status: DONE
blockedBy: []
branch: feat/gmail-layer-a
created: 2026-01-27T06:00:00Z
updated: 2026-01-27T07:50:00Z

# Layer-by-layer status (worker updates this)
layers:
  A_INGESTION:
    status: DONE
    tests: E2E
    notes: "OAuth + Gmail fetch with history API"
  B_GATE:
    status: DONE
    tests: E2E
    notes: "Pre-AI filtering, sanitization"
  C_READER:
    status: DONE
    tests: E2E
    notes: "Claude classification with structured JSON output"
  D_CRITIC:
    status: DONE
    tests: 13 unit
    notes: "Typed rules, SQLite rate limits, RuleEngine"
  E_ACTOR:
    status: DONE
    tests: 14 unit
    notes: "Gmail executor, dry_run=True default, safety checks"
  F_MEMORY:
    status: DONE
    tests: stub
    notes: "Pass-through stub - returns empty defaults"
  G_AUDIT:
    status: DONE
    tests: minimal
    notes: "JSONL logger at ~/.arkai-gmail/audit.jsonl"

# Context files
context:
  - docs/ARKAI_GMAIL_DESIGN.md
  - .ralph/memory/tickets/GMAIL_HYBRID_CRITIC.yaml
  - .ralph/memory/tickets/GMAIL_PROVIDER_ABSTRACTION.yaml

# Acceptance criteria for full pipeline
acceptance:
  - description: "Dry-run triage works end-to-end"
    cmd: "cd ~/AI/arkai-gmail && python3.11 -m arkai_gmail.cli triage --dry-run --limit 3"
    expect: "Shows classification + critic verdict for 3 emails"

  - description: "Execute mode requires explicit flag"
    cmd: "cd ~/AI/arkai-gmail && python3.11 -m arkai_gmail.cli triage --help"
    expect: "--execute"

  - description: "All unit tests pass"
    cmd: "cd ~/AI/arkai-gmail && python3.11 -m pytest"
    expect: "passed"

  - description: "Critic blocks forbidden actions"
    manual: true
    description: "Test email with forbidden action gets BLOCK verdict"

  - description: "Actor respects dry_run"
    manual: true
    description: "Dry-run shows actions but doesn't execute them"

# Deliverables
deliverables:
  - path: ~/AI/arkai-gmail/src/arkai_gmail/
    description: "Full pipeline implementation"
  - path: ~/AI/arkai-gmail/tests/
    description: "Unit tests for all layers"

# Worker fills proofs when complete
proofs:
  e2e_dry_run: |
    PASSED - 2026-01-27 07:45 UTC
    Fetched 3 emails, all classified as NEWSLETTER (95%)
    Gate: 3 OK, 0 FLAG, 0 SKIP
    Sanitization working (67.3% reduction)
  e2e_execute: |
    PASSED - 2026-01-27 07:47 UTC
    3 emails processed end-to-end:
    - Julian Goldie → NEWSLETTER → APPROVE → EXECUTED
    - Brain.fm → NEWSLETTER → APPROVE → EXECUTED
    - AIAgentStore.ai → NEWSLETTER → APPROVE → EXECUTED
    All actions: add_label, archive, mark_read = success
  audit_log: |
    PASSED - audit.jsonl contains:
    - timestamp, email_id, from, subject
    - category, confidence, verdict
    - rule_hits (empty = no rules triggered)
    - executed: true, actions with status
  unit_tests: "27 passing (13 critic + 14 actor)"
  classification_quality: |
    Excellent - all 3 test emails correctly identified as newsletters
    95% confidence, appropriate actions proposed
  validated_by: "master session (Claude Opus 4.5)"

# Risk assessment
risk: |
  MEDIUM RISK - Email automation has consequences

  Mitigations in place:
  - dry_run=True default
  - Critic blocks forbidden actions
  - Forward requires explicit flag
  - Rate limits prevent runaway

rollback: |
  # Disable execution
  # Just don't use --execute flag

  # Revoke Gmail access if needed
  rm ~/.arkai-gmail/token.json

notes: |
  ## MVP Definition
  For MVP, F (Memory) can be stubbed. G (Audit) should at least log to file.

  ## Post-MVP
  - Provider abstraction (GMAIL_PROVIDER_ABSTRACTION ticket)
  - LLM Advisor in Critic (GMAIL_HYBRID_CRITIC ticket, FUTURE)
  - Memory layer for learned preferences
