# Ticket: Voice Intake v1 Implementation
# Worker: voice-builder
# Priority: HIGH (but blocked by Phase 0 conceptually - can start in parallel for code)

id: VOICE_INTAKE_V1
worker: voice-builder
status: DONE
blockedBy: []
branch: feat/voice-intake-v1  # MERGED to main 2026-01-27
created: 2026-01-26T12:00:00Z
updated: 2026-01-27T02:45:00Z

# Files worker MUST read before starting
context:
  - .claude/CLAUDE.md                           # Project overview
  - contracts/voice_intake.schema.json          # OUTPUT MUST CONFORM TO THIS
  - docs/SECURITY_POSTURE.md                    # Reader/Actor pattern
  - docs/ARCHITECTURE.md                        # Voice pipeline flow diagram
  - src/ingest/queue.rs                         # Existing queue implementation
  - src/ingest/watcher.rs                       # Existing watcher implementation

# What to do
task: |
  Implement Voice Intake v1: the complete pipeline from voice memo detection to
  classified artifact in Obsidian.

  SCOPE BOUNDARIES:
  - YES: Intent classification, confidence, canonical artifact, daily summary, idempotency
  - NO: Streaming, TTS, VPS whisper, extra features

  PATTERN: Follow Reader/Actor split from SECURITY_POSTURE.md
  - Reader (LLM): Classifies intent, outputs JSON only, has NO tools
  - Actor (Code): Writes to Obsidian, updates Claudia memory

  Implementation Tasks:

  1. INTENT CLASSIFICATION
     - Enum: NOTE | TASK | IDEA | QUESTION | COMMAND
     - Confidence score: 0.0 to 1.0
     - For COMMAND intent: requires_confirmation = true always

  2. CANONICAL ARTIFACT WRITE
     - Location: ~/Obsidian/MyVault/Inbox/Voice/{date}__{content_hash}.md
     - Stable ID from content hash (SHA256[0:12])
     - Frontmatter with: id, created, source, intent, confidence, duration
     - Body with: summary, transcript, timestamps (collapsible)

  3. DAILY SUMMARY FOR CLAUDIA
     - Location: ~/.arkai/summaries/{YYYY-MM-DD}/voice.json
     - Aggregate all voice memos from that day
     - Include: count, intents breakdown, key topics, action items
     - Claudia reads this for morning briefing

  4. IDEMPOTENCY
     - Same audio file processed twice = same output, no duplicate
     - Use content hash as deduplication key
     - Check queue before processing: if hash exists with status=done, skip

  5. QUEUE STATUS UPDATES
     - Write events to voice_queue.jsonl per existing pattern
     - Status progression: pending â†’ processing â†’ done | failed

# Machine-checkable acceptance criteria
acceptance:
  - description: "arkai voice process --once completes without error"
    cmd: "cargo run -- voice process --once 2>&1"
    expect_not: "error"
    expect_not: "panic"

  - description: "Output conforms to voice_intake.schema.json"
    manual: true
    description: "Validate queue item JSON against schema"

  - description: "Canonical artifact created with stable ID"
    manual: true
    description: "Process same file twice, verify same output path"

  - description: "Daily summary written"
    cmd: "ls ~/.arkai/summaries/$(date +%Y-%m-%d)/voice.json"
    expect: "voice.json"

  - description: "Idempotency: no duplicates on re-process"
    manual: true
    description: "Process file, process again, verify single artifact"

  - description: "Intent classification present"
    manual: true
    description: "Output JSON includes intent enum and confidence"

# Expected outputs
deliverables:
  - path: src/ingest/classifier.rs
    description: "Intent classification logic (Reader pattern)"
  - path: src/ingest/depositor.rs
    description: "Obsidian artifact writer (Actor pattern)"
  - path: src/ingest/summarizer.rs
    description: "Daily summary generator"
  - path: tests/fixtures/sample_voice_1.m4a
    description: "Test audio file 1"
    optional: true
  - path: tests/fixtures/sample_voice_2.m4a
    description: "Test audio file 2"
    optional: true
  - path: tests/fixtures/expected_output_1.json
    description: "Expected classification for sample 1"
  - path: tests/fixtures/expected_output_2.json
    description: "Expected classification for sample 2"
  - path: tests/voice_intake_test.rs
    description: "Integration test proving idempotency"

# Worker fills these in when complete
proofs:
  cargo_build: "Finished release profile [optimized] target(s) in 13.67s"
  process_once: |
    ğŸ¦ Processing voice queue â†’ Claudia (Clawdbot)
       Model: base
    ğŸ™ï¸  Processing: 20120505 210914-89EA8CF1.m4a (dabe4055)
       ğŸ“ Transcribing with Whisper (base)...
       âœ… Transcribed (129s, 284 chars)
       ğŸ“¤ Sending to Claudia...
       âœ… Sent to Claudia!
  artifact_path: "/home/clawdbot/obsidian-vault-sandbox/voice-inbox/2026-01-27_0229_musical-riff.md"
  e2e_test: "PASSED - Full pipeline: Macâ†’Whisperâ†’VPSâ†’Claudiaâ†’Obsidianâ†’Gitâ†’Mac"
  master_verified: "2026-01-27 by master session 3"

# Risk assessment
risk: |
  OBSIDIAN PATH: Hardcoded vault path may not exist on all machines.
  Use config or environment variable.

  WHISPER DEPENDENCY: If using local whisper, binary must be installed.
  Document in README or check at startup.

  TELEGRAM ROUTE: If using Telegram for transcription, needs bot token.
  Fail gracefully if not configured.

rollback: |
  If artifacts are malformed:
    rm ~/Obsidian/MyVault/Inbox/Voice/{date}__*.md
    # Re-run with fixes

  If queue is corrupted:
    # Queue is append-only, so just add correcting events
    # Or backup and recreate: mv voice_queue.jsonl voice_queue.jsonl.bak

# Do not modify these docs (propose changes separately)
protected_files:
  - docs/SECURITY_POSTURE.md
  - docs/ARCHITECTURE.md
  - contracts/voice_intake.schema.json  # This is your target, not to modify

error: null

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HANDOFF NOTES (voice-builder session)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

handoff:
  architecture_decision: |
    Mac transcribes locally via Whisper, VPS (Claudia) classifies and deposits.
    This avoids GPU requirements on VPS and leverages Mac's Apple Silicon.

    Flow: Voice Memo â†’ Watcher â†’ Queue â†’ Whisper â†’ ClawdbotClient â†’ Claudia
    Claudia then: classifies intent â†’ writes to Obsidian â†’ responds via Telegram

  what_was_built:
    - src/adapters/clawdbot.rs: ClawdbotClient for VPS webhook
    - src/ingest/transcriber.rs: Local Whisper shell-out
    - src/ingest/watcher.rs: Voice Memos file watcher
    - src/ingest/queue.rs: JSONL event-sourced queue
    - src/cli/voice.rs: CLI with --route flag (telegram | clawdbot)

  env_vars_needed:
    CLAWDBOT_TOKEN: "Required for clawdbot route - Bearer token for VPS"
    CLAWDBOT_ENDPOINT: "Optional - defaults to http://arkai-clawdbot:18789/hooks/agent"
    WHISPER_PATH: "Optional - defaults to /opt/homebrew/bin/whisper"
    TELEGRAM_BOT_TOKEN: "Required for telegram route"
    TELEGRAM_CHAT_ID: "Required for telegram route"

  cli_usage:
    scan: "arkai voice scan"
    process_telegram: "arkai voice process --route telegram --once"
    process_clawdbot: "arkai voice process --route clawdbot --model base --once"
    process_clawdbot_with_tg: "arkai voice process --route clawdbot --chat-id 123456 --once"

  not_built:
    - src/ingest/classifier.rs: "Not needed - Claudia does classification on VPS"
    - src/ingest/depositor.rs: "Not needed - Claudia writes to Obsidian"
    - src/ingest/summarizer.rs: "Not needed - Claudia handles daily summaries"
    - Integration tests: "Need Whisper + VPS connectivity to test"

  testing_needed:
    - "Test clawdbot route with real CLAWDBOT_TOKEN"
    - "Verify Tailscale connectivity to VPS (100.81.12.50)"
    - "End-to-end: voice memo â†’ transcription â†’ Claudia response"
